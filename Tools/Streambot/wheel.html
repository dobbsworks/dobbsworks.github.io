<html>
	<head>
    <title>Wheel of Levels</title>
	</head>
	<body>
		<div style="display:none;">
			<canvas height="100" width="100" id="pattern" ></canvas>

			<div id="icons">
				<image src="https://dobbsworks.github.io/Tools/Streambot/images/star-icon.png"></image>
				<image src="https://dobbsworks.github.io/Tools/Streambot/images/heart-icon.png"></image>
				<image src="https://dobbsworks.github.io/Tools/Streambot/images/bowser-icon.png"></image>
			</div>

			<audio id="audio1" src="https://dobbsworks.github.io/Games/SayWhen/audio/high.mp3"></audio>
			<audio id="bowserLaugh" src="https://dobbsworks.github.io/Tools/Streambot/audio/sm64_bowser_laugh.wav"></audio>
		</div>
	</body>
	<script type="text/javascript">
	
let baseSize = Math.floor(Math.min(window.innerWidth, window.innerHeight));
let margin = 50;
let r = (baseSize / 2) - margin;
let center = (baseSize / 2);
let pegCount = 12;

let canvas = document.createElement("canvas");
canvas.height = baseSize;
canvas.width = baseSize;
canvas.style.position = "fixed";
canvas.style.left = "0";
canvas.style.top = "0";
document.body.appendChild(canvas);
let ctx = canvas.getContext("2d");
document.body.style.backgroundColor = "magenta";

let items = [];

// need to avoid color offset to allow for chroma-key
let colorOffset = Math.random()*360;
colorOffset = 0;
let rotation = 0;
let rotationSpeed = 0;


let confetti = [];
let music = null;
let cheer = null;
let bowserEvent = (Math.random() < 0.12) ? RandomFrom(["reversal", "revolution"]) : "";

function init() {
	let ytid = RandomFrom([
		"gDn4NRVkG4Y", // BK Furnace Fun
		"RMhhcz8wfEU", // SMRPG victory
		"OhLVrfMKiKg", // DK64 bonus
		"72qGczM5OTs", // runaway 5
		"WV_0d4KfpK0", // Pilotwings intro
		"3EjSwg-eNAo&t=11", // DKC3 bonus
		"ABr_f0pV_y0", // SM64 slide
		"yIFloLCk_Y0", // MK64 time trial
		"g5qo57gwn9s", // SSB64 bonus,
		"bcTk-xyIkug", // BKN&B bonus
		"nlSBjGguILk", // Mario Golf TT speed golf
		"E-4Nk466iIo", // Binding of Isaac arcade
		"4lBl-9vb1Vs", // Sticker Star - Pay or Fray
		"b2cPvHAcFVo", // Space Station Silicon Valley - bonus
	]);
	if (!ytid) ytid = "gDn4NRVkG4Y";
	if (bowserEvent) ytid = "Rz-J4WJnkIM" // 3d World Bowser theme
	music = PlayAudio(ytid);
	for (let i = 0; i < 100; i++) {
		confetti.push({
			x: Math.random() * window.innerWidth,
			y: Math.random() * window.innerHeight,
			timer: 100 * Math.random(),
			color: ["red","blue","lime"][Math.floor(Math.random()*3)]
		});
	}
	
	items.forEach(item => item.text = item.name.substring(0,14));

	if (bowserEvent) {
		if (bowserEvent === "revolution") items.forEach(item => item.targetWeight = 1);
		if (bowserEvent === "reversal") items.forEach(item => item.targetWeight = 1 / item.weight);
	}

	createPatterns();
	setInterval(loop, 1000/60);
	setupTimers();
}

let patterns = {};
function createPatterns() {
	let iconDiv = document.getElementById("icons");
	let c = document.getElementById("pattern");
	let patternCtx = c.getContext("2d");
	for (let iconImg of iconDiv.children) {
		let name = iconImg.src.substring(iconImg.src.lastIndexOf("/")+1).replace("-icon.png","");
		let pattern = ctx.createPattern(iconImg, 'repeat');
		patterns[name] = pattern;
	}
}

function draw() {
	ctx.clearRect(0,0,baseSize, baseSize);
	
	let totalWeight = items.map(x => x.weight).reduce((a,b)=>a+b,0);
	let cumulativeWeight = 0;
	for (let index = 0; index < items.length; index++) {
		let item = items[index];
		// 270 instead of 360 and +20 to aoid magentas (chroma-key)
		let hue = Math.floor(270 / items.length * index + colorOffset) % 360 + 20;
		let sat = "75%";
		let lum = "50%";
		if (winnerIndex > -1 && winnerIndex !== index) {
			sat = "25%";
			lum = "75%";
		}
		let color = "hsl(" + hue + ", " + sat + "," + lum + ")";
		item.t1 = cumulativeWeight / totalWeight * (2*Math.PI);
		item.t2 = (cumulativeWeight + item.weight) / totalWeight * (2*Math.PI);
		
		cumulativeWeight += item.weight;	
		ctx.fillStyle = color;
		ctx.beginPath();
		ctx.moveTo(center, center);
		ctx.arc(center, center, r, item.t1+rotation, item.t2+rotation);
		ctx.lineTo(center, center);
		ctx.fill();
		if (bowserEvent) {
			ctx.fillStyle = patterns.bowser;
			ctx.fill();
		} else if (item.badges.some(x => x.toLowerCase().indexOf("subscriber") > -1)) {
			ctx.fillStyle = patterns.star;
			if (item.name.toLowerCase() === "peffe29") ctx.fillStyle = patterns.heart;
			ctx.fill();
		}  
	}
	ctx.fillStyle = "black";
	for (let i=0; i<pegCount; i++) {
		let theta = Math.PI*2 / pegCount * i + rotation;
		let x = center + r * Math.cos(theta);
		let y = center + r * Math.sin(theta);
		ctx.beginPath();
		ctx.arc(x, y, 5, 0, 2*Math.PI);
		ctx.fill();
	}

	ctx.beginPath();
	ctx.moveTo(center, margin);
	ctx.lineTo(center+15, 5);
	ctx.lineTo(center, 0);
	ctx.lineTo(center-15, 5);
	ctx.fill();
	
	
	// outlines
	ctx.lineWidth = 2;
	ctx.strokeStyle = "black";	
	ctx.beginPath();
	ctx.arc(center, center, r, 0, 2*Math.PI);
	ctx.stroke();
	for (let item of items) {	
		ctx.beginPath();
		ctx.moveTo(center, center);
		ctx.lineTo(center + r * Math.cos(item.t1+rotation), center + r * Math.sin(item.t1+rotation));
		ctx.stroke();
	}
	
	
	// name labels
	ctx.fillStyle = "white";
	ctx.strokeStyle = "black";	
	ctx.lineWidth = 5;
	let textHeight = 30;
	ctx.font = textHeight + "px Arial";
	if (winnerIndex <= -1) {
		for (let nameIndex = 0; nameIndex < items.length; nameIndex++) {
			if (nameIndex >= nameRevealCount) break;
			if (nameIndex < nameHideCount) continue;
			let item = items[nameIndex];
			let textWidth = ctx.measureText(item.text).width;
			let centerX = center + 0.75 * r * Math.cos((item.t1+item.t2)/2+rotation);
			let centerY = center + 0.75 * r * Math.sin((item.t1+item.t2)/2+rotation);
			ctx.strokeText(item.text, centerX - textWidth/2, centerY + textHeight/4);
			ctx.fillText(item.text, centerX - textWidth/2, centerY + textHeight/4);
		}	
	}
	
	// winner name text
	ctx.font = "50px Arial";
	if (winnerIndex > -1) {
		let winner = items[winnerIndex];
		let text = winner.name;
		let textWidth = ctx.measureText(text).width;
		ctx.strokeText(text, center - textWidth/2, center);
		ctx.fillText(text, center - textWidth/2, center);
		
		text = "wins!"
		textWidth = ctx.measureText(text).width;
		ctx.strokeText(text, center - textWidth/2, center + 60);
		ctx.fillText(text, center - textWidth/2, center + 60);
		
		// confetti
		for (let c of confetti) {
			ctx.fillStyle = c.color;
			for (let a =0; a<4; a++)
				ctx.fillRect(c.x, c.y + a * window.innerHeight/4, 3, 3);
		}
	}
	
	
	if (bowserAdjust >= 1) {
		drawBowserTitle("BOWSER", 450);
		drawBowserTitle(bowserEvent.toUpperCase() , 550);
	}
}

function drawBowserTitle(text, y) {	
	ctx.lineWidth = 15;
	ctx.fillStyle = "red";
	ctx.strokeStyle = "black";	
	ctx.font = "100px Grobold";
	let textWidth = ctx.measureText(text).width;
	ctx.strokeText(text, center - textWidth/2, y);
	ctx.fillText(text, center - textWidth/2, y);
}

function getSelectedItem() {
	// PI/2 == bottom
	let targetAngle = 3*Math.PI/2;
	let selected = null;
	for (let x of items) {
		let p1 = (x.t1 + rotation) % (Math.PI*2);
		let p2 = (x.t2 + rotation) % (Math.PI*2);
		if (p2 <= p1) p2 = p1 + Math.PI*2;
		if (p1 < targetAngle && p2 >= targetAngle) selected = x;
	}
	return selected;
}

function determineWinner() {
	let winner = getSelectedItem();	
	winnerIndex = items.indexOf(winner);
	setTimeout(() => {SendWinner(winner.name)}, 100);
	setTimeout(() => {
		if (music) music.close();
		if (cheer) cheer.close();
		window.close();
	}, 8000);
}

let nameRevealCount = 0;
let nameHideCount = 0;
let rotationAccel = 1;
let winnerIndex = -1;
let bowserAdjust = -1;
function setupTimers() {
	let timer = 2000;
	
	// show name tags
	for (let i=0; i<items.length; i++) {
		setTimeout(() => {nameRevealCount++}, timer);
		timer += 200;
	}
	timer += 1000;


	// bowser event
	if (bowserEvent) {
		setTimeout(PlayLaugh, timer);
		setTimeout(() => {bowserAdjust = 2}, timer);
		timer += 4000;
		setTimeout(() => {bowserAdjust = 1}, timer);
		timer += 3000;
		setTimeout(() => {bowserAdjust = 0}, timer);
		timer += 1000;
	} else {
		timer += 2000;
	}
	

	

	// start spinning
	setTimeout(() => {rotationSpeed = 0.01}, timer);
	timer += 5;
	// speed up
	setTimeout(() => {rotationAccel = 1.02}, timer);
	timer += 2000;
	
	// steady speed for a random duration
	setTimeout(() => {rotationAccel = 1.00}, timer);
	timer += 2000 + 1000*Math.random();
	
	// dampen speed
	setTimeout(() => {rotationAccel = 0.99}, timer);
	timer += 9000;
	setTimeout(() => {rotationAccel = 0.9}, timer);
	timer += 1000;

	// random events
	let randomRoll = Math.random();
	if (randomRoll < 0.02) {
		setTimeout(() => {
			PlayLaugh();
			rotationSpeed = -0.02;
			rotationAccel = 1.04;
		}, timer);
		timer += 680;
		setTimeout(() => {rotationAccel = 0.9}, timer);
		timer += 1000;
	}
	
	// hard stop
	setTimeout(() => {cheer = PlayAudio("barWV7RWkq0");}, timer);
	setTimeout(() => {rotationSpeed = 0; rotationAccel = 1.00;}, timer);
	timer += 1000;
	
	// highlight winner cell
	setTimeout(determineWinner, timer);
	timer += 1000;
}

function SendWinner(winningUser) {
	console.log("Sending user " + winningUser);
	(new BroadcastChannel('helper')).postMessage('!randomwin ' + winningUser);
}


function loop() {	
	draw();
	rotationSpeed *= rotationAccel;
	rotation += rotationSpeed;

	if (bowserAdjust === 1) {
		items.forEach(item => {
			item.weight += 0.05 * (item.targetWeight - item.weight)
		});
	}
	if (bowserAdjust === 0) {
		items.forEach(item => {
			item.weight = item.targetWeight
		});
	}
	
	for (let c of confetti) {
		c.y += c.timer/100 + 1;
		if (c.y > window.innerHeight/4) c.y -= window.innerHeight/4;
		c.x += (c.timer - 50)/50;
		c.timer +=1;
		if (c.timer > 100) c.timer -= 100;
	}

	let currentPie = Math.floor(rotation / (Math.PI*2 / pegCount));
	let previousPie = Math.floor((rotation-rotationSpeed) / (Math.PI*2 / pegCount));
	if (currentPie !== previousPie) {
		PlayTone();
	}
	
}


function SetItems(x) {
	items = x;
}

function PlayAudio(ytid) {
	let w = window.open("https://www.youtube.com/watch?v=" + ytid);
	return w;
}

function PlayTone() {
	let tone = document.getElementById("audio1");
	tone.pause();
	tone.currentTime = 0;
	tone.play();
}

function PlayLaugh() {
	let tone = document.getElementById("bowserLaugh");
	tone.pause();
	tone.currentTime = 0;
	tone.play();
}

function RandomFrom(list) {
	let index = RandomNumber(list.length) - 1;
	return list[index];
}
function RandomNumber(min, max) {
	if (max === undefined) {
		max = min;
		min = 1;
	}
	return min + Math.floor(Math.random() * (1+max-min))
}


	</script>
</html>
