<html>

<head>
	<title>test</title>

	<style>
		* {
			transition-property: all;
			transition-duration: 0.5s;
		}

		html,
		body {
			overflow: hidden;
		}

		body {
			background-color: #92cddb;
		}

	</style>
</head>

<body>

	<canvas id="animation" width="800" height="600"></canvas>
	<img src="baseImage.png" id="sourceImage" />

</body>
<script type="text/javascript">

	var cellSize = 50;
	var cells = [];

	function Init() {
		cells = CreateCells();
		Loop();
	}

	function Loop() {
		Update();
		Draw();
		requestAnimationFrame(Loop);
	}

	function CreateCells() {
		var image = document.getElementById("sourceImage");
		var tempCanvas = document.createElement("canvas");
		tempCanvas.width = image.width;
		tempCanvas.height = image.height;
		console.log(image.width, image.height)
		var ctx = tempCanvas.getContext('2d');
		ctx.drawImage(image, 0, 0);
		var imageData = ctx.getImageData(0,0,image.width,image.height).data;

		cells = [];
		for (let y=0; y<image.height; y++) {
			for (let x=0; x<image.width; x++) {
				let cellIndex = (y * image.width + x) * 4;
				let red = imageData[cellIndex];
				let green = imageData[cellIndex+1];
				let blue = imageData[cellIndex+2];
				var cell = {
					color: `rgb(${red},${green},${blue})`,
					imageX: x,
					imageY: y,
					x: x * cellSize,
					y: y * cellSize - 500 + Math.random()*30,
					dy: 0, 
					baseY: y * cellSize,
				}
				cells.push(cell);
			}
		}
		return cells;
	}

	function Draw() {
		let canvas = document.getElementById("animation");
		let ctx = canvas.getContext('2d');
		ctx.clearRect(0,0,canvas.width,canvas.height);
		for (let cell of cells) {
			ctx.fillStyle = cell.color;
			ctx.fillRect(cell.x, cell.y, cellSize, cellSize);
		}
	}

	function Update() {
		for (let cell of cells) {
			cell.dy += 0.1;
			cell.y += cell.dy;
			if (cell.y > cell.baseY) {
				cell.y -= (cell.y - cell.baseY);
				cell.dy *= -0.3;
			}
		}
	}

	var image = document.getElementById("sourceImage");
	image.onload = Init;
</script>

</html>